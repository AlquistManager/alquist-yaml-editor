<html>
<head>
    <script type="text/javascript" src="viz.js"></script>
    <script type="text/javascript" src="jquery-3.1.1.min.js"></script>
    <script type="text/javascript" src="svg-pan-zoom.min.js"></script>

    <style type="text/css">
        #mynetwork {
            width: 1000px;
            height: 800px;
            border: 5px solid lightgray;
        }

        ellipse {
            stroke-width: 1px;
        }
    </style>


</head>
<body>

<div id="graph_main"></div>

<script type="text/javascript">

    var elem = document.getElementById("graph_main");

    var statePositions;
    var fileNames;
    var yamlMap = new Map();
    var botName;


    //loads graph file
    jQuery.ajaxSetup({async: false});
    $.get("graph_viz.txt", function (response) {
        elem.innerHTML += Viz(response, "svg");
    }, 'text');

    //loads positions of states in yaml files
    $.get("state_positions.txt", function (response) {
        statePositions = response;
        fileNames = findFileNames();

        for (i = 0; i < fileNames.length; i++) {
            if(fileNames[i] == undefined)continue;
            $.get("bots/" + botName + "/flows/" + fileNames[i], function (res) {
                yamlMap.set(fileNames[i], res);
            }, 'text');
        }
    }, 'text');

    jQuery.ajaxSetup({async: true});

    var nodes = document.getElementsByClassName("node");
    var edges = document.getElementsByClassName("edge");

    for (i = 0; i < nodes.length; i++) {
        //displays part of yaml code after click on node
        nodes[i].addEventListener('click', function (evt) {
            var state = evt.currentTarget.firstChild.firstChild.data;
            var statePos = findPosition(state).split(" ");
            var text = getYamlCode(statePos[1], statePos[2], statePos[3]);
            alert(text);
        });

        //highlights nodes and edges on mouseover
        nodes[i].addEventListener('mouseover', function (evt) {
            var ellipse = evt.currentTarget.children[1];
            ellipse.style.strokeWidth = "5px";

            for(i = 0; i < edges.length; i++){
                var nodeName = evt.currentTarget.firstChild.firstChild.data;
                var title = edges[i].firstElementChild.firstChild.data;
                var splittedTitle = title.split("->");
                if(splittedTitle[0] == nodeName || splittedTitle[1] == nodeName){
                    var path = edges[i].children[1];
                    path.style.strokeWidth = "5px";
                }
            }

        });

        //stops highlighting
        nodes[i].addEventListener('mouseout', function (evt) {
            var ellipse = evt.currentTarget.children[1];
            ellipse.style.strokeWidth = "1px";

            for(i = 0; i < edges.length; i++){
                var nodeName = evt.currentTarget.firstChild.firstChild.data;
                var title = edges[i].firstElementChild.firstChild.data;
                var splittedTitle = title.split("->");
                if(splittedTitle[0] == nodeName || splittedTitle[1] == nodeName){
                    var path = edges[i].children[1];
                    path.style.strokeWidth = "1px";
                }
            }
        });
    }

    var panZoomGraph = svgPanZoom(elem.firstElementChild, {controlIconsEnabled: true, minZoom: 0.1, maxZoom: 20});

    //finds line with position information of a state
    function findPosition(state) {
        var lines = statePositions.split("\n");
        for (i = 0; i < lines.length; i++) {
            var line = lines [i];
            var splittedLine = line.split(" ");
            if (state == splittedLine[0]) {
                return line;
            }
        }
    }

    //finds file names of yaml files
    function findFileNames() {
        var files = [];
        var lines = statePositions.split("\n");
        botName = lines[0];
        for (i = 1; i < lines.length; i++) {
            var line = lines [i];
            var splittedLine = line.split(" ");
            if (files.indexOf(splittedLine[1]) == -1) {
                files.push(splittedLine[1]);
            }
        }
        return files;
    }

    //gets yaml code from a chosen file from startLine to endLine
    function getYamlCode(file, startLine, endLine) {
        var code = "";
        var response = yamlMap.get(file);
        var lines = response.split("\n");
        var startL = parseInt(startLine);
        var endL = parseInt(endLine);
        for (var i = startL; i < endL; i++) {
            code += lines[i] + "\n";
        }
        return code;
    }

</script>


</body>
</html>