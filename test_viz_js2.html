<html>
<head>
    <script type="text/javascript" src="static/viz.js"></script>
    <script type="text/javascript" src="static/jquery-3.1.1.min.js"></script>
    <script type="text/javascript" src="static/svg-pan-zoom.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/split.js/1.2.0/split.min.js"></script>
    <script type="text/javascript" src="static/taboverride.min.js"></script>

    <link rel="stylesheet" href="static/themes/default/style.min.css"/>
    <script type="text/javascript" src="static/jstree.min.js"></script>


    <style type="text/css">
        #graph_main {
            width: 500px;

            height: 100vh;
            border: 5px solid lightgray;
            overflow: hidden;
        }

        #editor {
            height: 100vh;
            width: 200px;
        }

        ellipse {
            stroke-width: 1px;
        }

    </style>


    <style>
        html, body {
            height: 100%;
        }

        body {
            padding: 1px;
            background-color: #F6F6F6;
            box-sizing: border-box;
        }

        .split {
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;

            overflow-y: auto;
            overflow-x: hidden;
        }

        .content {
            border: 1px solid #C0C0C0;
            box-shadow: inset 0 1px 2px #e4e4e4;
            background-color: #fff;
        }

        .gutter {
            background-color: transparent;

            background-repeat: no-repeat;
            background-position: 50%;
        }

        .gutter.gutter-horizontal {
            cursor: col-resize;
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAFAQMAAABo7865AAAABlBMVEVHcEzMzMzyAv2sAAAAAXRSTlMAQObYZgAAABBJREFUeF5jOAMEEAIEEFwAn3kMwcB6I2AAAAAASUVORK5CYII=');
        }

        .gutter.gutter-vertical {
            cursor: row-resize;
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAeCAYAAADkftS9AAAAIklEQVQoU2M4c+bMfxAGAgYYmwGrIIiDjrELjpo5aiZeMwF+yNnOs5KSvgAAAABJRU5ErkJggg==');
        }

        .split.split-horizontal, .gutter.gutter-horizontal {
            height: 100%;
            float: left;
        }

        .split.split-horizontal {
            border: 1px solid #C0C0C0;
            box-shadow: inset 0 1px 2px #e4e4e4;
            background-color: #fff;
        }

        .text-editor {
            width: 100%;
            height: 95%;
        }

        #loader {
            position: absolute;
            left: 50%;
            top: 50%;
            z-index: 1;
            width: 150px;
            height: 150px;
            margin: -75px 0 0 -75px;
            border: 16px solid #f3f3f3;
            border-radius: 50%;
            border-top: 16px solid #3498db;
            width: 120px;
            height: 120px;
            -webkit-animation: spin 2s linear infinite;
            animation: spin 2s linear infinite;
        }

        @-webkit-keyframes spin {
            0% {
                -webkit-transform: rotate(0deg);
            }
            100% {
                -webkit-transform: rotate(360deg);
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>


</head>
<body>


<div id="loader"></div>
<div id="panes" style="visibility: hidden;" class="split">
    <div id="file_tree" class="split split-horizontal file-tree">
        <div id="file_tree_inner"></div>
        <button id="new_file" onclick="onClickNewFile()">New file</button>
        <button id="delete_file" onclick="onClickDeleteFile()">Delete file</button>
    </div>
    <div id="graph_main" class="split split-horizontal"></div>
    <div id="editor" class="split split-horizontal">
        <textarea class="text-editor" id="text-editor"></textarea>
        <button type="button" id="button_update">Update</button>
        <button type="button" id="button_download" onclick="download()">Download project</button>
    </div>
</div>

<script type="text/javascript">

    //var applicationURL = "http://thawing-escarpment-24517.herokuapp.com/";//"http://thawing-escarpment-24517.herokuapp.com/"; //127.0.0.1:5000
    var elemGraph = document.getElementById("graph_main");

    // get a reference to the textarea element
    var textarea = document.getElementById('text-editor');

    // enable Tab Override for the textarea
    tabOverride.set(textarea);

    var statePositions;
    var fileNames;
    var yamlMap = new Map();
    var botName;
    var currentFile;
    var responseToGenerate;

    document.getElementById("text-editor").value = "";

    Split(['#file_tree', '#graph_main', '#editor'], {
        sizes: [20, 55, 24.5],
        //minSize: [200,200],
        direction: 'horizontal',
        gutterSize: 8,
        cursor: 'col-resize'
    });

    botName = findGetParameter("bot");
    generateGraphForBot(botName);
    console.log("generated graph for bot: " + botName);

    function loadGraph() {

        jQuery.ajaxSetup({async: false});

        findFileNames();

        $.post("graph", "getGraph",
            function (data, status) {
                elemGraph.innerHTML = Viz(data, "svg");
                console.log("get graph file: " + status);
            });

        $.post("statepos", "getStatePositions",
            function (data, status) {
                statePositions = data;
                console.log("get state positions: " + status);
            });

        for (i = 0; i < fileNames.length; i++) {
            if (fileNames[i] == undefined)continue;
            var filepath = "bots/" + botName + "/flows/" + fileNames[i];
            $.post("getfile", filepath,
                function (data, status) {
                    yamlMap.set(fileNames[i], data);
                    console.log("get yaml file: " + status);
                });
        }

        var nodes = document.getElementsByClassName("node");
        var edges = document.getElementsByClassName("edge");

        if (nodes.length == 0) {
            elemGraph.innerHTML = "Error parsing Yaml file or emty Yaml file.<br>" + responseToGenerate;
        }

        jQuery.ajaxSetup({async: true});

        for (i = 0; i < nodes.length; i++) {
            //displays part of yaml code after click on node
            nodes[i].addEventListener('click', function (evt) {
                var state = evt.currentTarget.firstChild.firstChild.data;
                var statePos = findPosition(state).split(" ");
                var text2 = getYamlFile(statePos[1]);
                document.getElementById("text-editor").value = text2;
                currentFile = statePos[1];
            });

            //highlights nodes and edges on mouseover
            nodes[i].addEventListener('mouseover', function (evt) {
                var ellipse = evt.currentTarget.children[1];
                ellipse.style.strokeWidth = "5px";

                for (i = 0; i < edges.length; i++) {
                    var nodeName = evt.currentTarget.firstChild.firstChild.data;
                    var title = edges[i].firstElementChild.firstChild.data;
                    var splittedTitle = title.split("->");
                    if (splittedTitle[0] == nodeName || splittedTitle[1] == nodeName) {
                        var path = edges[i].children[1];
                        path.style.strokeWidth = "5px";
                    }
                }

            });

            //stops highlighting
            nodes[i].addEventListener('mouseout', function (evt) {
                var ellipse = evt.currentTarget.children[1];
                ellipse.style.strokeWidth = "1px";

                for (i = 0; i < edges.length; i++) {
                    var nodeName = evt.currentTarget.firstChild.firstChild.data;
                    var title = edges[i].firstElementChild.firstChild.data;
                    var splittedTitle = title.split("->");
                    if (splittedTitle[0] == nodeName || splittedTitle[1] == nodeName) {
                        var path = edges[i].children[1];
                        path.style.strokeWidth = "1px";
                    }
                }
            });
        }

        if (nodes.length != 0) {
            var panZoomGraph = svgPanZoom(elemGraph.firstElementChild, {
                controlIconsEnabled: true,
                minZoom: 0.1,
                maxZoom: 20
            });

            //panZoomGraph.zoom(1.5);
            panZoomGraph.center();
        }

        showPage();

        if (nodes.length != 0) {
            setSvgSizeToParent();
        }

        var zoomControls = document.getElementById("svg-pan-zoom-controls");
        if (zoomControls != undefined) {
            var zoomControlsY = elemGraph.firstElementChild.parentNode.clientHeight - 100;
            zoomControls.setAttribute("transform", "translate(10 " + zoomControlsY + ")");
        }

    }

    loadGraph();

    //finds line with position information of a state
    function findPosition(state) {
        var lines = statePositions.split("\n");
        for (i = 0; i < lines.length; i++) {
            var line = lines [i];
            var splittedLine = line.split(" ");
            if (state == splittedLine[0]) {
                return line;
            }
        }
    }

    //finds file names of yaml files
    function findFileNames() {
        $.post("filenames", botName, function (data, status) {
            files = data.split(";");
            fileNames = files;
        });
    }

    //gets yaml code from a chosen file from startLine to endLine
    function getYamlCode(file, startLine, endLine) {
        var code = "";
        var response = yamlMap.get(file);
        var lines = response.split("\n");
        var startL = parseInt(startLine);
        var endL = parseInt(endLine);
        for (var i = startL; i < endL; i++) {
            code += lines[i] + "\n";
        }
        return code;
    }

    //gets complete yaml file
    function getYamlFile(file) {
        var response = yamlMap.get(file);
        return response;
    }

    function showPage() {
        document.getElementById("loader").style.display = "none";
        document.getElementById("panes").style.visibility = "visible";
    }

    function generateGraphForBot(botname) {
        $.post("generate", botname,
            function (data, status) {
                console.log("generate graph for bot: " + status);
                responseToGenerate = data;
            });
    }

    function toPython(usrdata) {
        var editor_text = document.getElementById("text-editor").value;
        if (editor_text.trim() == "" || currentFile == undefined)return;

        $.post("update",
            JSON.stringify({botname: botName, filename: currentFile, text: editor_text}),
            function (data, status) {
                loadGraph();
                console.log(status);
            });
    }

    document.getElementById("button_update").addEventListener("click", function (evt) {
        toPython(botName);
    });

    function setSvgSizeToParent() {
        var newWidth = elemGraph.firstElementChild.parentNode.clientWidth;
        var newHeight = elemGraph.firstElementChild.parentNode.clientHeight;
        elemGraph.firstElementChild.setAttribute("width", newWidth);
        elemGraph.firstElementChild.setAttribute("height", newHeight);
    }

    /*
     var zoomControls = document.getElementById("svg-pan-zoom-controls");
     if (zoomControls != undefined) {
     var zoomControlsY = elemGraph.firstElementChild.parentNode.clientHeight - 100;
     zoomControls.setAttribute("transform", "translate(10 " + zoomControlsY + ")");
     }*/


    function generateFileTree() {
        $.post("filenamesHtml", botName, function (data, status) {
            document.getElementById("file_tree_inner").innerHTML = data;
            $('#file_tree_inner').jstree();


            $('#file_tree_inner')
            // listen for event
                .on('select_node.jstree', function (e, data) {
                    currentFile = data.instance.get_node(data.selected[0]).text;
                    var fileContent = getYamlFile(currentFile);
                    document.getElementById("text-editor").value = fileContent;
                })
                // create the instance
                .jstree();
        });
    }

    generateFileTree();

    function findGetParameter(parameterName) {
        var result = null,
            tmp = [];
        var items = location.search.substr(1).split("&");
        for (var index = 0; index < items.length; index++) {
            tmp = items[index].split("=");
            if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
        }
        return result;
    }

    function download() {
        window.open("download/" + botName, "_self");
    }

    function onClickNewFile() {
        var name = prompt("Enter name of the new file:", "");
        var data = name + ";" + botName;

        $.post("newfile", data,
            function (data, status) {
                console.log("create new file: " + status);
                $('#file_tree_inner').jstree(true).destroy();
                generateFileTree();
            });
    }

    function onClickDeleteFile() {
        if (currentFile != undefined && currentFile != "") {
            if (confirm("Delete " + currentFile + "?")) {
                data = currentFile + ";" + botName;
                $.post("deletefile", data,
                    function (data, status) {
                        $('#file_tree_inner').jstree(true).destroy();
                        generateFileTree();
                    });
            }
        }
    }

</script>


</body>
</html>