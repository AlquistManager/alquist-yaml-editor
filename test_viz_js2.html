<html>
<head>
    <script src="static/viz.js"></script>
    <script src="static/jquery-3.1.1.min.js"></script>
    <script src="static/svg-pan-zoom.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/split.js/1.2.0/split.min.js"></script>
    <script src="static/taboverride.min.js"></script>
    <script src="static/jquery.highlight-within-textarea.js"></script>

    <link rel="stylesheet" href="static/jquery.highlight-within-textarea.css"/>
    <link rel="stylesheet" href="static/themes/default/style.min.css"/>
    <script src="static/jstree.min.js"></script>
    <link rel="stylesheet" href="static/style.css"/>
    <title>Alquist Editor</title>
</head>
<body>


<div id="loader"></div>
<div id="panes" style="visibility: hidden;" class="split">
    <div id="file_tree" class="split split-horizontal file-tree">
        <div id="file_tree_inner"></div>
    </div>
    <div id="graph_main" class="split split-horizontal"></div>
    <div id="editor" class="split split-horizontal">
        <textarea class="text-editor" id="text-editor"></textarea>
        <button type="button" id="button_update">Update</button>
        <button type="button" id="button_download" onclick="download()">Download project</button>
    </div>
</div>


<nav class="context-menu">
    <ul class="context-menu__items">
        <li class="context-menu__item" onclick="onClickNewFile()">
            <a href="#" class="context-menu__link">
                <i class="fa fa-add"></i> New File
            </a>
        </li>
        <li class="context-menu__item" onclick="onClickDeleteFile()">
            <a href="#" class="context-menu__link">
                <i class="fa fa-edit"></i> Delete File
            </a>
        </li>
    </ul>
</nav>

<nav class="context-menu-root">
    <ul class="context-menu__items">
        <li class="context-menu__item" onclick="onClickNewFile()">
            <a href="#" class="context-menu__link">
                <i class="fa fa-add"></i> New File
            </a>
        </li>
    </ul>
</nav>

<script>
    var elemGraph = document.getElementById("graph_main");
    var i;

    var statePositions;
    var fileNames;
    var yamlMap = new Map();
    var botName;
    var currentFile;
    var responseToGenerate;
    var tarea = document.getElementById("text-editor");
    var treeElement;

    // enable Tab Override for the textarea
    tabOverride.set(tarea);

    // clear text area
    document.getElementById("text-editor").value = "";

    // initialize split panes
    Split(['#file_tree', '#graph_main', '#editor'], {
        sizes: [20, 55, 24.5],
        //minSize: [200,200],
        direction: 'horizontal',
        gutterSize: 8,
        cursor: 'col-resize'
    });

    //find bot name
    botName = findGetParameter("bot");

    generateGraphForBot(botName);
    console.log("generated graph for bot: " + botName);

    //loads and displays graph
    function loadGraph() {

        jQuery.ajaxSetup({async: false});
        findFileNames();

        // get graph data and display it using Graphviz
        $.post("graph", "getGraph",
            function (data, status) {
                elemGraph.innerHTML = Viz(data, "svg");
                console.log("get graph file: " + status);
            });

        // get positions of states in yaml files
        $.post("statepos", "getStatePositions",
            function (data, status) {
                statePositions = data;
                console.log("get state positions: " + status);
            });

        // load yaml files
        for (i = 0; i < fileNames.length; i++) {
            if (fileNames[i] == undefined)continue;
            var filepath = "bots/" + botName + "/flows/" + fileNames[i];
            $.post("getfile", filepath,
                function (data, status) {
                    yamlMap.set(fileNames[i], data);
                    console.log("get yaml file: " + status);
                });
        }

        var nodes = document.getElementsByClassName("node");
        var edges = document.getElementsByClassName("edge");

        // displays error message when parsing fails
        if (nodes.length == 0) {
            elemGraph.innerHTML = "Error parsing Yaml file.<br>" + responseToGenerate.replace(/(?:\r\n|\r|\n)/g, '<br />');
        }

        jQuery.ajaxSetup({async: true});


        for (i = 0; i < nodes.length; i++) {
            // onclick event of graph nodes, displays yaml code in editor and highlights state name
            nodes[i].addEventListener('click', function (evt) {
                var state = evt.currentTarget.firstChild.firstChild.data;
                var statePos = findPosition(state).split(" ");
                var text2 = getYamlFile(statePos[1]);
                document.getElementById("text-editor").value = text2;
                currentFile = statePos[1];
                selectTextareaLine(tarea, statePos[2]);
            });

            //highlights nodes and edges on mouseover
            nodes[i].addEventListener('mouseover', function (evt) {
                var ellipse = evt.currentTarget.children[1];
                ellipse.style.strokeWidth = "5px";

                for (i = 0; i < edges.length; i++) {
                    var nodeName = evt.currentTarget.firstChild.firstChild.data;
                    var title = edges[i].firstElementChild.firstChild.data;
                    var splittedTitle = title.split("->");
                    if (splittedTitle[0] == nodeName || splittedTitle[1] == nodeName) {
                        var path = edges[i].children[1];
                        path.style.strokeWidth = "5px";
                    }
                }

            });

            //stops highlighting
            nodes[i].addEventListener('mouseout', function (evt) {
                var ellipse = evt.currentTarget.children[1];
                ellipse.style.strokeWidth = "1px";

                for (i = 0; i < edges.length; i++) {
                    var nodeName = evt.currentTarget.firstChild.firstChild.data;
                    var title = edges[i].firstElementChild.firstChild.data;
                    var splittedTitle = title.split("->");
                    if (splittedTitle[0] == nodeName || splittedTitle[1] == nodeName) {
                        var path = edges[i].children[1];
                        path.style.strokeWidth = "1px";
                    }
                }
            });
        }

        // initialize panning and zooming library
        if (nodes.length != 0) {
            var panZoomGraph = svgPanZoom(elemGraph.firstElementChild, {
                controlIconsEnabled: true,
                minZoom: 0.1,
                maxZoom: 20
            });

            //panZoomGraph.zoom(1.5);
            panZoomGraph.center();
        }

        showPage();

        if (nodes.length != 0) {
            setSvgSizeToParent();
        }

        // set position fo zoom controls
        var zoomControls = document.getElementById("svg-pan-zoom-controls");
        if (zoomControls != undefined) {
            var zoomControlsY = elemGraph.firstElementChild.parentNode.clientHeight - 100;
            zoomControls.setAttribute("transform", "translate(10 " + zoomControlsY + ")");
        }

    }

    loadGraph();

    //finds line with position information of a state
    function findPosition(state) {
        var lines = statePositions.split("\n");
        for (i = 0; i < lines.length; i++) {
            var line = lines [i];
            var splittedLine = line.split(" ");
            if (state == splittedLine[0]) {
                return line;
            }
        }
    }

    //finds file names of yaml files
    function findFileNames() {
        $.post("filenames", botName, function (data, status) {
            files = data.split(";");
            fileNames = files;
        });
    }

    //gets yaml code from a chosen file from startLine to endLine
    function getYamlCode(file, startLine, endLine) {
        var code = "";
        var response = yamlMap.get(file);
        var lines = response.split("\n");
        var startL = parseInt(startLine);
        var endL = parseInt(endLine);
        for (var i = startL; i < endL; i++) {
            code += lines[i] + "\n";
        }
        return code;
    }

    //gets complete yaml file
    function getYamlFile(file) {
        var response = yamlMap.get(file);
        return response;
    }

    // display page after loading
    function showPage() {
        document.getElementById("loader").style.display = "none";
        document.getElementById("panes").style.visibility = "visible";
    }

    // request to generate a new graph
    function generateGraphForBot(botname) {
        $.post("generate", botname,
            function (data, status) {
                console.log("generate graph for bot: " + status);
                responseToGenerate = data;
            });
    }

    // update graph with yaml code from editor
    function toPython(usrdata) {
        var editor_text = document.getElementById("text-editor").value;
        if (editor_text.trim() == "" || currentFile == undefined)return;

        $.post("update",
            JSON.stringify({botname: botName, filename: currentFile, text: editor_text}),
            function (data, status) {
                loadGraph();
                console.log(status);
            });
    }

    // update button - send new yaml code to python
    document.getElementById("button_update").addEventListener("click", function (evt) {
        toPython(botName);
    });

    //  sets size of graph SVG to match parent
    function setSvgSizeToParent() {
        var newWidth = elemGraph.firstElementChild.parentNode.clientWidth;
        var newHeight = elemGraph.firstElementChild.parentNode.clientHeight;
        elemGraph.firstElementChild.setAttribute("width", newWidth + document.getElementById('panes').clientWidth);
        elemGraph.firstElementChild.setAttribute("height", newHeight);
    }

    // request file data and generate corresponding file tree
    function generateFileTree() {
        $.post("filenamesHtml", botName, function (data, status) {
            document.getElementById("file_tree_inner").innerHTML = data;
            $('#file_tree_inner').jstree();


            $('#file_tree_inner')
            // listen for event
                .on('select_node.jstree', function (e, data) {
                    currentFile = data.instance.get_node(data.selected[0]).text;
                    var fileContent = getYamlFile(currentFile);
                    document.getElementById("text-editor").value = fileContent;
                })
                // create the instance
                .jstree();

            addNodeListeners("jstree-leaf", "context-menu");
            addNodeListeners("jstree-anchor", "context-menu-root");
        });
    }

    generateFileTree();

    // adds listeners for custom context menu in filetree
    function addNodeListeners(itemClassName, contextMenuName) {
        var taskItemClassName = itemClassName;
        var menu = document.getElementsByClassName(contextMenuName)[0];
        var menuState = 0;
        var activeClassName = "context-menu--active";
        var menuPosition;
        var menuPositionX;
        var menuPositionY;

        function getPosition(e) {
            var posx = 0;
            var posy = 0;

            if (!e) var e = window.event;

            if (e.pageX || e.pageY) {
                posx = e.pageX;
                posy = e.pageY;
            } else if (e.clientX || e.clientY) {
                posx = e.clientX + document.body.scrollLeft +
                    document.documentElement.scrollLeft;
                posy = e.clientY + document.body.scrollTop +
                    document.documentElement.scrollTop;
            }

            return {
                x: posx,
                y: posy
            }
        }

        function positionMenu(e) {
            menuPosition = getPosition(e);
            menuPositionX = menuPosition.x + "px";
            menuPositionY = menuPosition.y + "px";

            menu.style.left = menuPositionX;
            menu.style.top = menuPositionY;
        }

        function clickInsideElement(e, className) {
            var el = e.srcElement || e.target;

            if (contextMenuName == "context-menu-root") {
                el1 = el;
                while (el1 = el1.parentNode) {
                    if (el1.classList && el1.classList.contains("jstree-leaf")) {
                        return false;
                    }
                }
            }

            if (el.classList.contains(className)) {
                return el;
            } else {
                while (el = el.parentNode) {
                    if (el.classList && el.classList.contains(className)) {
                        return el;
                    }
                }
            }

            return false;
        }

        /**
         * Initialise our application's code.
         */
        function init() {
            contextListener();
            clickListener();
            keyupListener();
        }

        /**
         * Listens for contextmenu events.
         */
        function contextListener() {
            document.addEventListener("contextmenu", function (e) {
                if (treeElementTemp = clickInsideElement(e, taskItemClassName)) {
                    treeElement = treeElementTemp;
                    e.preventDefault();
                    toggleMenuOn();
                    positionMenu(e);
                } else {
                    toggleMenuOff();
                }
            });
        }

        function toggleMenuOff() {
            if (menuState !== 0) {
                menuState = 0;
                menu.classList.remove(activeClassName);
            }
        }

        /**
         * Listens for click events.
         */
        function clickListener() {
            document.addEventListener("click", function (e) {
                var button = e.which || e.button;
                if (button === 1) {
                    toggleMenuOff();
                }
            });
        }

        /**
         * Listens for keyup events.
         */
        function keyupListener() {
            window.onkeyup = function (e) {
                if (e.keyCode === 27) {
                    toggleMenuOff();
                }
            }
        }

        /**
         * Turns the custom context menu on.
         */
        function toggleMenuOn() {
            if (menuState !== 1) {
                menuState = 1;
                menu.classList.add(activeClassName);
            }
        }

        /**
         * Run the app.
         */
        init();

    }

    // find bot name passed by GET method
    function findGetParameter(parameterName) {
        var result = null,
            tmp = [];
        var items = location.search.substr(1).split("&");
        for (var index = 0; index < items.length; index++) {
            tmp = items[index].split("=");
            if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
        }
        return result;
    }

    // download project code
    function download() {
        window.open("download/" + botName, "_self");
    }

    // create new yaml file
    function onClickNewFile() {
        var name = prompt("Enter name of the new file:", "");
        if (name == "" || name == null || name == undefined)return;
        var data = name + ";" + botName;

        $.post("newfile", data,
            function (data, status) {
                console.log("create new file: " + status);
                $('#file_tree_inner').jstree(true).destroy();
                generateFileTree();
            });
    }

    // delete selected file
    function onClickDeleteFile() {
        if (treeElement != undefined) {
            if (confirm("Delete " + treeElement.lastChild.lastChild.data + "?")) {
                data = treeElement.lastChild.lastChild.data + ";" + botName;
                $.post("deletefile", data,
                    function (data, status) {
                        $('#file_tree_inner').jstree(true).destroy();
                        generateFileTree();
                    });
            }
        }
        treeElement = undefined;
    }

    //selects one line in a textarea
    function selectTextareaLine(tarea, lineNum) {
        lineNum--; // array starts at 0
        var lines = tarea.value.split("\n");

        // calculate start/end
        var startPos = 0, endPos = tarea.value.length;
        for (var x = 0; x < lines.length; x++) {
            if (x == lineNum) {
                break;
            }
            startPos += (lines[x].length + 1);
        }

        var endPos = lines[lineNum].length + startPos;

        if (typeof(tarea.selectionStart) != "undefined") {
            tarea.focus();

            var lineHeight = tarea.scrollHeight / lines.length;
            var jump = (lineNum - 10) * lineHeight;
            tarea.scrollTop = jump;

            tarea.selectionStart = startPos;
            tarea.selectionEnd = endPos;
            tarea.focus();
            $.event.trigger({type: 'keypress'});
        }
        return false;
    }

</script>


</body>
</html>