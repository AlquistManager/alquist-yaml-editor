<html>
<head>
    <script type="text/javascript" src="static/viz.js"></script>
    <script type="text/javascript" src="static/jquery-3.1.1.min.js"></script>
    <script type="text/javascript" src="static/svg-pan-zoom.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/split.js/1.2.0/split.min.js"></script>
    <script type="text/javascript" src="static/taboverride.min.js"></script>

    <link rel="stylesheet" href="static/themes/default/style.min.css"/>
    <script type="text/javascript" src="static/jstree.min.js"></script>


    <style type="text/css">
        #graph_main {
            width: 500px;

            height: 100vh;
            border: 5px solid lightgray;
            overflow: hidden;
        }

        #editor {
            height: 100vh;
            width: 200px;
        }

        ellipse {
            stroke-width: 1px;
        }
    </style>


    <style>
        html, body {
            height: 100%;
        }

        body {
            padding: 1px;
            background-color: #F6F6F6;
            box-sizing: border-box;
        }

        .split {
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;

            overflow-y: auto;
            overflow-x: hidden;
        }

        .content {
            border: 1px solid #C0C0C0;
            box-shadow: inset 0 1px 2px #e4e4e4;
            background-color: #fff;
        }

        .gutter {
            background-color: transparent;

            background-repeat: no-repeat;
            background-position: 50%;
        }

        .gutter.gutter-horizontal {
            cursor: col-resize;
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAFAQMAAABo7865AAAABlBMVEVHcEzMzMzyAv2sAAAAAXRSTlMAQObYZgAAABBJREFUeF5jOAMEEAIEEFwAn3kMwcB6I2AAAAAASUVORK5CYII=');
        }

        .gutter.gutter-vertical {
            cursor: row-resize;
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAeCAYAAADkftS9AAAAIklEQVQoU2M4c+bMfxAGAgYYmwGrIIiDjrELjpo5aiZeMwF+yNnOs5KSvgAAAABJRU5ErkJggg==');
        }

        .split.split-horizontal, .gutter.gutter-horizontal {
            height: 100%;
            float: left;
        }

        .split.split-horizontal {
            border: 1px solid #C0C0C0;
            box-shadow: inset 0 1px 2px #e4e4e4;
            background-color: #fff;
        }

        .text-editor {
            width: 100%;
            height: 95%;
        }

        #loader {
            position: absolute;
            left: 50%;
            top: 50%;
            z-index: 1;
            width: 150px;
            height: 150px;
            margin: -75px 0 0 -75px;
            border: 16px solid #f3f3f3;
            border-radius: 50%;
            border-top: 16px solid #3498db;
            width: 120px;
            height: 120px;
            -webkit-animation: spin 2s linear infinite;
            animation: spin 2s linear infinite;
        }

        @-webkit-keyframes spin {
            0% {
                -webkit-transform: rotate(0deg);
            }
            100% {
                -webkit-transform: rotate(360deg);
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>


</head>
<body>


<div id="loader"></div>
<div id="panes" style="visibility: hidden;" class="split">
    <div id="file_tree" class="split split-horizontal file-tree"></div>
    <div id="graph_main" class="split split-horizontal"></div>
    <div id="editor" class="split split-horizontal">
        <textarea class="text-editor" id="text-editor"></textarea>
        <button type="button" id="button_update">Update</button>
    </div>
</div>

<script type="text/javascript">

    var applicationURL = "http://127.0.0.1:5000/";//"http://thawing-escarpment-24517.herokuapp.com/"; //127.0.0.1:5000
    var elem = document.getElementById("graph_main");

    // get a reference to the textarea element
    var textarea = document.getElementById('text-editor');

    // enable Tab Override for the textarea
    tabOverride.set(textarea);

    var statePositions;
    var fileNames;
    var yamlMap = new Map();
    var botName;
    var currentFile;

    document.getElementById("text-editor").value = "";

    Split(['#file_tree', '#graph_main', '#editor'], {
        sizes: [20, 55, 24.5],
        //minSize: [200,200],
        direction: 'horizontal',
        gutterSize: 8,
        cursor: 'col-resize'
    });

    botName = findGetParameter("bot");
    generateGraphForBot(botName);
    console.log("generated graph for bot: " + botName);

    function loadGraph() {
        //loads graph file
        /*jQuery.ajaxSetup({async: false});
         $.get("graph_viz.txt", function (response) {
         elem.innerHTML = Viz(response, "svg");
         }, 'text');*/

        jQuery.ajaxSetup({async: false});
        $.post(applicationURL + "graph", "getGraph",
            function (data, status) {
                elem.innerHTML = Viz(data, "svg");
                console.log("get graph file: " + status);
            });

        //loads positions of states in yaml files
        /*$.get("state_positions.txt", function (response) {
         statePositions = response;
         fileNames = findFileNames();

         for (i = 0; i < fileNames.length; i++) {
         if (fileNames[i] == undefined)continue;
         $.get("bots/" + botName + "/flows/" + fileNames[i], function (res) {
         yamlMap.set(fileNames[i], res);
         }, 'text');
         }
         }, 'text');*/

        $.post(applicationURL + "statepos", "getStatePositions",
            function (data, status) {
                statePositions = data;
                fileNames = findFileNames();
                console.log("get state positions: " + status);
            });

        for (i = 0; i < fileNames.length; i++) {
            if (fileNames[i] == undefined)continue;
            var filepath = "bots/" + botName + "/flows/" + fileNames[i];
            $.post(applicationURL + "getfile", filepath,
                function (data, status) {
                    yamlMap.set(fileNames[i], data);
                    console.log("get yaml file: " + status);
                });
        }


        jQuery.ajaxSetup({async: true});

        var nodes = document.getElementsByClassName("node");
        var edges = document.getElementsByClassName("edge");


        for (i = 0; i < nodes.length; i++) {
            //displays part of yaml code after click on node
            nodes[i].addEventListener('click', function (evt) {
                var state = evt.currentTarget.firstChild.firstChild.data;
                var statePos = findPosition(state).split(" ");
                var text2 = getYamlFile(statePos[1]);
                document.getElementById("text-editor").value = text2;
                currentFile = statePos[1];
            });

            //highlights nodes and edges on mouseover
            nodes[i].addEventListener('mouseover', function (evt) {
                var ellipse = evt.currentTarget.children[1];
                ellipse.style.strokeWidth = "5px";

                for (i = 0; i < edges.length; i++) {
                    var nodeName = evt.currentTarget.firstChild.firstChild.data;
                    var title = edges[i].firstElementChild.firstChild.data;
                    var splittedTitle = title.split("->");
                    if (splittedTitle[0] == nodeName || splittedTitle[1] == nodeName) {
                        var path = edges[i].children[1];
                        path.style.strokeWidth = "5px";
                    }
                }

            });

            //stops highlighting
            nodes[i].addEventListener('mouseout', function (evt) {
                var ellipse = evt.currentTarget.children[1];
                ellipse.style.strokeWidth = "1px";

                for (i = 0; i < edges.length; i++) {
                    var nodeName = evt.currentTarget.firstChild.firstChild.data;
                    var title = edges[i].firstElementChild.firstChild.data;
                    var splittedTitle = title.split("->");
                    if (splittedTitle[0] == nodeName || splittedTitle[1] == nodeName) {
                        var path = edges[i].children[1];
                        path.style.strokeWidth = "1px";
                    }
                }
            });
        }
        var panZoomGraph = svgPanZoom(elem.firstElementChild, {controlIconsEnabled: true, minZoom: 0.1, maxZoom: 20});

        panZoomGraph.zoom(1.5);
        panZoomGraph.center();

        showPage();
        setSvgSizeToParent();

    }

    loadGraph();

    //finds line with position information of a state
    function findPosition(state) {
        var lines = statePositions.split("\n");
        for (i = 0; i < lines.length; i++) {
            var line = lines [i];
            var splittedLine = line.split(" ");
            if (state == splittedLine[0]) {
                return line;
            }
        }
    }

    //finds file names of yaml files
    function findFileNames() {
        var files = [];
        var lines = statePositions.split("\n");
        botName = lines[0];
        for (i = 1; i < lines.length; i++) {
            var line = lines [i];
            var splittedLine = line.split(" ");
            if (files.indexOf(splittedLine[1]) == -1) {
                files.push(splittedLine[1]);
            }
        }
        return files;
    }

    //gets yaml code from a chosen file from startLine to endLine
    function getYamlCode(file, startLine, endLine) {
        var code = "";
        var response = yamlMap.get(file);
        var lines = response.split("\n");
        var startL = parseInt(startLine);
        var endL = parseInt(endLine);
        for (var i = startL; i < endL; i++) {
            code += lines[i] + "\n";
        }
        return code;
    }

    //gets complete yaml file
    function getYamlFile(file) {
        var response = yamlMap.get(file);
        return response;
    }

    function showPage() {
        document.getElementById("loader").style.display = "none";
        document.getElementById("panes").style.visibility = "visible";
    }

    function generateGraphForBot(botname) {
        $.post(applicationURL + "generate", botname,
            function (data, status) {
                console.log("generate graph for bot: " + status);
            });
    }

    function toPython(usrdata) {
        var editor_text = document.getElementById("text-editor").value;
        if (editor_text.trim() == "" || currentFile == undefined)return;

        $.post(applicationURL + "update",
            JSON.stringify({botname: botName, filename: currentFile, text: editor_text}),
            function (data, status) {
                loadGraph();
                console.log(status);
            });
    }

    document.getElementById("button_update").addEventListener("click", function (evt) {
        toPython(botName);
    });

    function setSvgSizeToParent() {
        var newWidth = elem.firstElementChild.parentNode.clientWidth;
        var newHeight = elem.firstElementChild.parentNode.clientHeight;
        elem.firstElementChild.setAttribute("width", newWidth);
        elem.firstElementChild.setAttribute("height", newHeight);
    }

    var zoomControls = document.getElementById("svg-pan-zoom-controls");
    var zoomControlsY = elem.firstElementChild.parentNode.clientHeight - 100;
    zoomControls.setAttribute("transform", "translate(10 " + zoomControlsY + ")");

    $('#file_tree').jstree({
        'core': {
            'data': [
                'Simple root node',
                {
                    'text': 'Root node 2',
                    'state': {
                        'opened': true,
                        'selected': true
                    },
                    'children': [
                        {'text': 'Child 1'},
                        'Child 2'
                    ]
                }
            ]
        }
    });

    function findGetParameter(parameterName) {
        var result = null,
            tmp = [];
        var items = location.search.substr(1).split("&");
        for (var index = 0; index < items.length; index++) {
            tmp = items[index].split("=");
            if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
        }
        return result;
    }


</script>


</body>
</html>